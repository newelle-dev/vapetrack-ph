# Product & Variant Management

**Branch:** `feat/product-variant-management`
**Description:** Implement full CRUD for products with embedded variant management and automatic inventory record creation.

## Goal
Enable shop owners to add and edit products with multiple variants (flavors, nicotine levels, etc.), each with unique SKU, selling price, and capital cost. On creation, automatically generate inventory records for each variant across all active branches.

## Context

### Existing Patterns
- **Server Actions**: `ActionResult<T>` pattern with auth check, org lookup, Zod validation, `revalidatePath()` (see `categories.ts`, `branches.ts`)
- **Forms**: React Hook Form + `@hookform/resolvers` (Zod v4) + shadcn `Form` components (see `category-form.tsx`)
- **Currency**: Stored in **centavos** (integer). UI shows pesos via `formatCurrency()` from `@/lib/utils`
- **Slugs**: `slugify()` + `generateUniqueSlug()` from `@/lib/utils/slugify`
- **Layout**: `PageContainer` component for consistent page structure
- **Data Fetching**: TanStack Query hooks (`useProducts`, `useProductById`, `useCategories`)
- **Toasts**: `sonner` for success/error feedback

### Database Schema (from `types/database.ts`)
- **products**: `id, name, brand, description, category_id, slug, is_active, image_url, organization_id, deleted_at`
- **product_variants**: `id, name, sku, selling_price (centavos), capital_cost (centavos), product_id, is_active, low_stock_threshold, organization_id, deleted_at`
- **inventory**: `id, branch_id, product_variant_id, quantity, organization_id`
- **stock_movements**: `id, branch_id, product_variant_id, quantity_change, quantity_before, quantity_after, movement_type, organization_id`

### Missing Components
- shadcn `Select` component (not installed yet — needed for category dropdown)

---

## Implementation Steps

### Step 1: Add Select Component & Create Validation Schema
**Files:**
- `components/ui/select.tsx` (new — generated by shadcn CLI)
- `lib/validations/product.ts` (new)

**What:**
1. Install shadcn `select` component: `npx shadcn@latest add select`
2. Create Zod validation schema for product + variants:
   - `productSchema`: name (required, min 2 chars), brand (optional), description (optional), category_id (required UUID), is_active (default true)
   - `variantSchema`: name (required, min 1 char), sku (required, min 1 char, alphanumeric + dash), selling_price (required, positive integer — centavos), capital_cost (required, non-negative integer — centavos), initial_stock (optional, non-negative integer, default 0)
   - `createProductSchema`: product fields + `variants` array (min 1 variant required)
   - `updateProductSchema`: product fields + `variants` array with optional `id` field (existing variants have ID, new ones don't)

**Testing:** Import schema in a test file or verify at build time — Zod schemas should parse valid data and reject invalid data.

---

### Step 2: Create Product Server Actions
**Files:**
- `app/actions/products.ts` (new)

**What:**
Create server actions following the existing `ActionResult<T>` pattern from `categories.ts`:

1. **`createProduct(data)`**:
   - Auth check → get user org
   - Validate with `createProductSchema`
   - Generate product slug
   - Insert product row
   - Insert all variant rows (each gets `organization_id`, `product_id`)
   - Fetch all active branches for the organization
   - Insert inventory records (quantity = `initial_stock` or 0) for each variant × each branch
   - If initial_stock > 0, create `stock_movements` records (type: `initial_stock`)
   - Revalidate `/inventory` and `/inventory/products`
   - Return `{ success: true, data: { productId } }`

2. **`updateProduct(id, data)`**:
   - Auth check → get user org
   - Validate with `updateProductSchema`
   - Update product fields
   - For variants:
     - Variants WITH `id` → update existing
     - Variants WITHOUT `id` → insert new + create inventory records for all branches
     - Variants not in payload but in DB → soft-delete (set `deleted_at`)
   - Revalidate paths
   - Return `ActionResult`

3. **`getProductForEdit(id)`**:
   - Auth check → get user org
   - Fetch product with all non-deleted variants
   - Return typed product data for the edit form

**Note:** All DB operations that span multiple inserts should use individual Supabase calls (no raw SQL transactions needed — if one fails, the server action returns an error). For MVP this is acceptable; a Postgres function could be used later for true atomicity.

**Testing:** Create a product via the form → check Supabase dashboard that product, variants, and inventory records are created.

---

### Step 3: Build Product Form & Variant Manager Components
**Files:**
- `components/inventory/product-form.tsx` (new)
- `components/inventory/variant-manager.tsx` (new)

**What:**

1. **`ProductForm`** — Full-page form component (not dialog — products are complex):
   - Props: `initialData?` (for edit mode), `categories` (for dropdown)
   - React Hook Form with Zod resolver
   - Fields: Name (Input), Brand (Input, optional), Description (Textarea, optional), Category (Select dropdown)
   - Embeds `VariantManager` component
   - Submit button with loading state (`useTransition`)
   - Calls `createProduct()` or `updateProduct()` server action
   - Shows toast on success, redirects to `/inventory` on success
   - Shows inline validation errors

2. **`VariantManager`** — Dynamic variant list embedded in product form:
   - Uses `useFieldArray` from React Hook Form to manage variant rows
   - Each row: Name (Input), SKU (Input), Selling Price (number Input — user enters pesos, convert to centavos), Capital Cost (number Input — same centavo conversion), Initial Stock (number Input, only shown on create)
   - "Add Variant" button at bottom
   - Remove variant button (trash icon) on each row — minimum 1 variant required
   - Auto-generate SKU suggestion from product name + variant name (optional helper)
   - Mobile-responsive: Stack fields vertically on mobile, grid on desktop
   - Visual card for each variant with clear separation

**Design Notes:**
- Price inputs should show "₱" prefix and accept decimal pesos (e.g., "150.50") — convert to centavos (15050) before submission
- SKU field should show validation error if duplicate within the form
- Each variant card should have a subtle border and be visually distinct

**Testing:** Open the "Add Product" page, fill in product details, add 2+ variants, submit → verify all data saved correctly.

---

### Step 4: Create Add Product & Edit Product Pages
**Files:**
- `app/(dashboard)/inventory/products/new/page.tsx` (new)
- `app/(dashboard)/inventory/products/[id]/edit/page.tsx` (new)

**What:**

1. **Add Product Page** (`/inventory/products/new`):
   - Server Component that fetches categories
   - Renders `PageContainer` with title "Add Product" and back button
   - Renders `ProductForm` (client component) with categories passed as props
   - Breadcrumb or back link to `/inventory`

2. **Edit Product Page** (`/inventory/products/[id]/edit`):
   - Server Component that fetches product data (with variants) and categories
   - Passes both to `ProductForm` as `initialData`
   - If product not found → redirect to `/inventory` or show 404
   - Title: "Edit {product.name}"

**Testing:**
- Navigate to `/inventory/products/new` → form loads with empty fields
- Navigate to `/inventory/products/[id]/edit` → form loads with pre-filled data
- Submit both forms → verify data saved correctly

---

### Step 5: Wire Up Navigation & Update Inventory Page
**Files:**
- `app/(dashboard)/inventory/page.tsx` (modify)
- `components/inventory/product-table.tsx` (modify)
- `components/inventory/product-card.tsx` (modify)
- `components/inventory/product-details-dialog.tsx` (modify)

**What:**

1. **Inventory Page**: Update the "Create Product" button to link to `/inventory/products/new` using Next.js `Link`
2. **Product Table**: Add "Edit" action to each product row → links to `/inventory/products/[id]/edit`
3. **Product Card**: Add edit action to mobile card view
4. **Product Details Dialog**: Add "Edit Product" button that navigates to the edit page

**Testing:**
- Click "Create Product" → navigates to add form
- Click "Edit" on a product → navigates to edit form
- Full flow: create product → see it in list → edit it → verify changes

---

### Step 6: Update Roadmap & Final Polish
**Files:**
- `docs/product/roadmap.md` (modify)

**What:**
- Mark all Day 10-11 tasks as completed in the roadmap
- Update Sprint 2 completion percentage
- Verify all Definition of Done items:
  - [ ] Add product form validates required fields
  - [ ] Can add 1+ variants per product
  - [ ] Each variant has unique SKU (validated)
  - [ ] Product creation creates inventory records
  - [ ] Edit product pre-fills existing data
  - [ ] Can add new variants to existing products
  - [ ] All operations show success toast
  - [ ] Error handling shows user-friendly messages

**Testing:** Manual walk-through of complete flow end-to-end.
